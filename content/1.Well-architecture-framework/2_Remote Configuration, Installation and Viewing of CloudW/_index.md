---
title : "Automate configuration, installation and viewing of CloudWatch"
date : "`r Sys.Date()`"
weight : 2
chapter : false
---

## Overview
- This workshop help with repeated tasks of collecting data and analyzing log files generated by the application and underlying services 
- Improves your security posture by creating a record of activity or audit trail in your workload, enabling you to detect and investigate potential threats
- Utilizing AWS services:
    * AWS Systems Manager
    * Amazon CloudWatch 
    * S3
    * Athena
    * QuickSight
without having to directly access the instance, or accessing data 

**Best pratices**
1) **Configure service and application logging**: CloudWatch agent on an EC2 -> Apache Web server logs, SSH logs, boot logs
2) **Configure services and resources centrally**: configure your cloudwatch log agent by storing the configuration file in Systems manager Parameter store -> enables maintaining consistent, reusable configuration data
3) **Analyze logs centrally**: QuickSight -> collect logs from CloudWatch API
4) **Enable people to perform action at a distance**: System Manger to run command installing and start CW agent on your ec2 instance -> No need to ssh to the instance
5) **Reduce attack surface**: Can close SSH port on your instance, reducing the attack surface of the workload

**Topology**
![topo](/images/well_2/topo.PNG)

## Steps
- **[Step 1: Create base infrastructure for testing](#base-infrastructure)**
- **[Step 2: Store the CloudWatch config file in parameter store](#store-the-cloudwatch-config-file-in-parameter-store)**
- **[Step 3: Start the CloudWatch agent && generate logs](#start-the-cloudwatch-agent--generat-logs)**
- **[Step 4: Export logs to S3 && Query logs using Athena](#export-logs-to-s3--query-logs-using-athena)**
- **[Step 5: Create a QuickSight Visualization](#create-a-quicksight-visualization)**
#### Base infrastructure
Deploy the following services:
- VPC and public subnet with InternetGW
- EC2 instance for webserver
- CloudWatch Agent Role and SSM usage for EC2 instance
- S3 to store logs files

**Result**
EC2:
![1](/images/well_2/1.png)
![1](/images/well_2/1.2.png)
![1](/images/well_2/1.3.png)
EC2 role:
![1](/images/well_2/1.4.png)
S3:
![1](/images/well_2/1.5.png)
Bucket policy: Allow CloudWatch service in "us-east-1" region to get the ACL and put objects to the S3 bucket.
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.us-east-1.amazonaws.com"
            },
            "Action": "s3:GetBucketAcl",
            "Resource": "arn:aws:s3:::automatecwlogs"
        },
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.us-east-1.amazonaws.com"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::automatecwlogs/lablogs/*"
        }
    ]
}
```
#### Store the CloudWatch config file in parameter store
**1) Install CloudWatch agent:**

The CloudWatch agent needs to be installed on the EC2 instance using SSM Run command:
- Perform actions on EC2 instances remotely.
- Manage the configuration of many instances with a single command. 
![2](/images/well_2/2.png)
Remember to enable S3 logs
![2](/images/well_2/2.1.png)

**2) Store the CloudWatch config file in parameter store (ssm parameter)**

Store the CW agent configuration file:
- For reusability
- Configuration data specifies which logs and metrics will be sent to CW as well as the source of this data

![3](/images/well_2/3.png)
The config file specifies which metrics and logs to collect:
1. The agent section specifies which user to run the logs agent as, and how frequently to collect logs.
2. The logs section specifies which log files to monitor and which log group and stream to place those logs in. This information can be seen in collect_list. 
3. The metrics section specifies which metrics are collected (in metrics_collected), the frequency of collection, measurement, and other details.
[Guide](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-Configuration-File-Details.html#CloudWatch-Agent-Configuration-File-Agentsection)
```json
{
	"agent": {
		"metrics_collection_interval": 60,
		"run_as_user": "root"
	},
	"logs": {
		"logs_collected": {
			"files": {
				"collect_list": [
					{
						"file_path": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log",
						"log_group_name": "securitylablogs",
						"log_stream_name": "cw-agent-logs"
					},
					{
						"file_path": "/var/log/httpd/access_log",
						"log_group_name": "securitylablogs",
						"log_stream_name": "apache-access-logs"
					},
					{
						"file_path": "/var/log/httpd/error_log",
						"log_group_name": "securitylablogs",
						"log_stream_name": "apache-error-logs"
					},
					{
						"file_path": "/var/log/boot.log",
						"log_group_name": "securitylablogs",
						"log_stream_name": "instance-boot-logs"
					},
					{
						"file_path": "/var/log/secure",
						"log_group_name": "securitylablogs",
						"log_stream_name": "ssh-logs"
					},
					{
						"file_path": "/var/log/yum.log",
						"log_group_name": "securitylablogs",
						"log_stream_name": "yum-logs"
					}
				]

			}
		}
	},
	"metrics": {
		"namespace" : "SecurityCWLab-Metrics",
		"append_dimensions": {
			"AutoScalingGroupName": "${aws:AutoScalingGroupName}",
			"ImageId": "${aws:ImageId}",
			"InstanceId": "${aws:InstanceId}",
			"InstanceType": "${aws:InstanceType}"
		},
		"metrics_collected": {
			"disk": {
				"measurement": [
					"used_percent"
				],
				"metrics_collection_interval": 60,
				"resources": [
					"*"
				]
			},
			"mem": {
				"measurement": [
					"mem_used_percent"
				],
				"metrics_collection_interval": 60
			}
		}
	}
}

```

#### Start the CloudWatch agent && generate logs
1. SSM run command to start the cloudwatch agent:
```shell
Document name prefix : Equals : AmazonCloudWatch-ManageAgent
AmazonCloudWatch-ManageAgent.
```
![4](/images/well_2/4.png)

2. Generate the logs:

Access to non-exist path route to generate '404' logs:

![5](/images/well_2/5.png)
**CloudWatch logs**
![5](/images/well_2/5.1.png)
![5](/images/well_2/5.2.png)

#### Export logs to S3 && Query logs using Athena
**Export CW logs to S3:**
![6](/images/well_2/6.png)
![6](/images/well_2/6.1.png)
**Query logs from S3 using Athena:**

Assign S3 location:
![7](/images/well_2/7.png)
Create new table:
![7](/images/well_2/7.1.png)
Query information of request send to EC2 target:
![7](/images/well_2/7.2.png)
```sql
CREATE EXTERNAL TABLE IF NOT EXISTS `security_lab_apache_access_logs` (
  request_date string,
  request_timestamp string,
  request_ip string,
  request_method string,
  request string,
  response_code int,
  response_size int,
  user_client_data string,
  garbage string
  )
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
WITH SERDEPROPERTIES (
 "input.regex" = "([^ ]*)T([^ ]*)Z ([^ ]*) (?:[^ ]* [^ ]*) (?:[^\"]*) \"([^ ]*) ([^\"]*)\" ([^ ]*) ([^ ]*) (?:\"[^\"]*\") (\"[^\"]*\")([^\n]*)"
 )
LOCATION 's3://automatecwlogs/lablogs/0387f6f8-daed-46d0-a54c-12e130e39e5d/apache-access-logs/'
TBLPROPERTIES (
  'compressionType' = 'gzip'
  );
```
![7](/images/well_2/7.3.png)

![7](/images/well_2/7.4.png)

![7](/images/well_2/7.5.png)

#### Create a QuickSight Visualization
[Sign up guide](https://docs.aws.amazon.com/quicksight/latest/user/signing-up.html)
![8](/images/well_2/8.png)
![8](/images/well_2/8.1.png)
![8](/images/well_2/8.2.png)
![8](/images/well_2/8.3.png)


