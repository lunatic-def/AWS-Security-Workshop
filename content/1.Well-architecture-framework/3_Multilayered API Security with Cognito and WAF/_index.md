---
title: "Multilayered API Security with Cognito and WAF"
date: "`r Sys.Date()`"
weight: 3
chapter: false
---

## Overview

- Secure public API by intergrating **Amazon API Gateway** with security services Cognito, CloudFront and AWS Web application firewall (WAF)
- Utilizing AWS services:
  - **API gateway** - used to create, public, maintain, monitor and secure APIs
  - **Secret manager** - securely store secrets
  - **Cloudfront** - prevent direct access to the API as well as enforce encrypted end-to-end connections to origin
  - **WAF** - used to protect an API by filtering,monitoring, and blocking malicious traffic
  - **Cognito** - Authenticate with user pools. User pools can provide the abiltiy for API consumers to obtain identity and access tokens which can then be used to enforce authorization controls on the API layer.

In this lab scenario -> demonstrate how to secure an API at multiple layers.
[Step 1: Create base infrastructure for testing](#base-infrastructure)
[Step 2: Manage secret manager for database and key rotation](#secret-manager--key-rotation)

### Base infrastructure

![1](/AWS-Security-Workshop/images/well_3/topo1.png)
**Setting up overviews**

**API Gateway**

1. The API Gateway has been provided with a role to allow access to invoke the Lambda function in the private subnet (application layer).
   The Lambda function has been provided with a role to allow the API Gateway to invoke the Lambda function.

```js
  lambdaApiGatewayInvoke:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !GetAtt 'LambdaRDSTest.Arn'
      Principal: 'apigateway.amazonaws.com'
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${apiGateway}/*/GET/'
```

**Lambda function**

2. Secrets Manager has been configured as the master password store which the Lambda function will retrieve to provide access to RDS. This will allow Secrets Manager to be used to encrypt, store and transparently decrypt the password when required.

```js
Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          -
            Effect: 'Allow'
            Principal:
              Service:
              - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      Path: '/'
      Policies:
        -
          PolicyName: 'AllowS3'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: 'Allow'
                Action: 's3:*'
                Resource: '*'
        -
          PolicyName: 'AllowSM'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              -
                Effect: 'Allow'
                Action: 'secretsmanager:*'
                Resource: '*'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
```

![1](/AWS-Security-Workshop/images/well_3/2.PNG)
Lambda create table function:
![1](/AWS-Security-Workshop/images/well_3/2-1.PNG)
![1](/AWS-Security-Workshop/images/well_3/2-2.PNG)
Lambda API GW function:
![1](/AWS-Security-Workshop/images/well_3/2-3.PNG)
![1](/AWS-Security-Workshop/images/well_3/2-4.PNG)
![1](/AWS-Security-Workshop/images/well_3/2-5.PNG)
**RDS**

3. Randomly generated RDS password with secret manager:

```js
  #This is a Secret resource with a randomly generated password in its SecretString JSON.
  WARDSInstanceRotationSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: "RDS MySQL password"
      GenerateSecretString:
        #SecretStringTemplate: !Sub '{"username": "admin"}'
        SecretStringTemplate: !Sub '{"username": "${RDSUserName}"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Name
          Value: WARDSPassword
```

![1](/AWS-Security-Workshop/images/well_3/1.PNG)

**Test lambda connection to rds:**

[walab-scripts](https://github.com/awswa/walab-scripts/tree/master)

```py
import sys
import requests

# print("Sending your request WITHOUT id token generated by Cognito.....")
def send_request(url):
    response = requests.get(url)
    return response
# print("Sending your request WITH id token generated by Cognito.....\n")
def send_request_with_token(url, id_token):
    response = requests.get(url, headers={'Authorization': id_token})
    return response
```

![1](/AWS-Security-Workshop/images/well_3/2-6.PNG)

### Secret manager && key rotation:

**Secret created for RDS**
![1](/AWS-Security-Workshop/images/well_3/3.PNG)
**Key rotation**

Enable key rotation
![1](/AWS-Security-Workshop/images/well_3/3-1.PNG)
{{% notice note %}}
**In order for rotation to work !**
{{% /notice %}}
"Lambda-rotation-function" created by the Secret-manager need to talk to:

- Other lambda needing to rotate the key
- Database and Secret manager service
  ![1](/AWS-Security-Workshop/images/well_3/3-2.PNG)
  ![1](/AWS-Security-Workshop/images/well_3/3-3.PNG)

Rotated password:
![1](/AWS-Security-Workshop/images/well_3/3-4.PNG)
Check lambda connection to rds again!!

### Preventing direct access to the API Gateway

Building a distribution of Cloudfront help with:

- Distribute traffic across multiple edge locations to improve performance
- Block requests from particular geographic locations from being served
- Enforce encrypted end-to-end connections to an origin API by using HTTPS
- Automatically close connections from slow reading or slow writing attackers

In this section of the lab, you will use a CloudFront custom header value generated by AWS Secrets Manager to restrict access to the API Gateway.
![topo2](/AWS-Security-Workshop/images/well_3/topo2.png)

**Restricting access on HTTP API Gateway Endpoint with Lambda Authorizer**

**Cloudfront:**

- Doesn't support unencrypted endpoints "http"
- Allowed method "GET","HEAD"
- Forward to API gateway with header's ID token generated with Cognito
- CDN with X-Origin-Verify header value using Secrets Manager, rotate header and it referrs to RotationRules

```js
OriginVerifyHeader:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Description: 'Origin Custom Header value for CloudFront'
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"HEADERVALUE": "RandomHeader"}'
        GenerateStringKey: "HEADERVALUE"
        ExcludePunctuation: true
```

- Permission to invoke Key-rotation lambda function "OriginSecretRotateFunction"

https://aws.amazon.com/vi/blogs/networking-and-content-delivery/restricting-access-http-api-gateway-lambda-authorizer/
